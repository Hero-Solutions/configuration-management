---
- name: Add apt repository on Debian/Ubuntu
  include_tasks: add_apt_repository.yml
  when: ansible_facts.distribution == 'Debian' or ansible_facts.distribution == 'Ubuntu'

- name: Add yum repository on AlmaLinux
  yum_repository:
    name: mongodb-org
    description: MongoDB Repository
    baseurl: https://repo.mongodb.org/yum/redhat/9/mongodb-org/7.0/x86_64/
    gpgkey: https://pgp.mongodb.com/server-7.0.asc
    repo_gpgcheck: true
  when: ansible_facts.distribution == 'AlmaLinux'

- name: Install mongodb-org on Debian/Ubuntu
  apt:
    name: mongodb-org
  notify: Restart mongodb
  when: ansible_facts.distribution == 'Debian' or ansible_facts.distribution == 'Ubuntu'

- name: Install mongodb-org on AlmaLinux
  dnf:
    name: mongodb-org
  notify: Restart mongodb
  when: ansible_facts.distribution == 'AlmaLinux'

- name: Flush handlers
  meta: flush_handlers

# Ansible mongodb_user is not (yet) compatible with pymongo 4.* so we have to hardcode version 3.12.2 for it to work
- name: Install pymongo
  pip:
    name:
      - pymongo==3.12.2

- name: Setup MongoDB root user
  community.mongodb.mongodb_user:
    database: admin
    name: "{{ datahub.mongodb.root_username }}"
    password: "{{ datahub.mongodb.root_password }}"
    roles: root
  become_user: "{{ application_user }}"

- name: Enable mongod
  service:
    name: mongod
    state: started
    enabled: true
